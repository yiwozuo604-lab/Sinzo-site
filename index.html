<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>bord</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
body { font-family: sans-serif; text-align: center; background-color: #e6f0ff; margin:0; padding:0; }
h1 { margin:10px 0; }
ul, ol { list-style: none; padding: 0; margin: 0; text-align:left; }
li { margin: 2px 0; padding: 8px; border-radius: 8px; cursor: pointer; word-wrap: break-word; color:#fff; position:relative; }
li small { display:block; font-size:0.8em; color:#f0f0f0; margin-top:2px; }
li span { white-space: pre-wrap; }
button { padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 20px; border: none; font-size: 16px; }
.greenBtn { background-color: #27ae60; color: white; }
.redBtn { background-color: #c0392b; color: white; }
#threadListSection { overflow-y: auto; padding: 10px; }
#threadDetailSection { display:none; text-align:left; overflow-y: auto; padding: 10px; }

/* ====== ä¸¦ã³æ›¿ãˆã‚»ãƒ¬ã‚¯ãƒˆï¼ˆä»Šå›è¿½åŠ ï¼‰ ====== */
#sortSelect {
  width: 230px;
  padding: 6px;
  margin: 8px auto;
  display: block;
  border-radius: 8px;
  font-size: 14px;
}

#popupForm {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 12px 16px;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0,0,0,0.5);
  z-index: 1000;
  width: 280px;
  max-width: 90%;
}
#overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 999; }
#loadingPopup { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.5); z-index:2000; text-align:center; }
.spinner { border:4px solid #f3f3f3; border-top:4px solid #3498db; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:0 auto 10px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
#loadingOkBtn { display:none; margin-top:10px; padding:6px 12px; border:none; border-radius:6px; background:#27ae60; color:#fff; cursor:pointer; }

label { display:block; text-align:left; margin-top:8px; font-size:14px; }

input, select {
  width:100%;
  box-sizing: border-box;
  padding:6px;
  margin-top:4px;
  border-radius:4px;
  border:1px solid #ccc;
  font-size:13px;
  height:28px;
}

textarea {
  width:100%;
  box-sizing: border-box;
  padding:6px;
  margin-top:4px;
  border-radius:4px;
  border:1px solid #ccc;
  font-size:13px;
  min-height:50px;
  resize: vertical;
}

.pageBtn { background-color:#2980b9; margin: 2px; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer;}
.pageBtn:disabled { background-color:#95a5a6; cursor:default; }

.nicknameWithIcon img { width:48px; height:48px; vertical-align:middle; margin-right:4px; border-radius:0; }

/* è©•ä¾¡ãƒœã‚¿ãƒ³ */
.threadRateBox { position: absolute; right: 12px; top: 12px; display:flex; gap:6px; align-items:center; }
.threadRateBtn {
  background: rgba(255,255,255,0.18);
  border: none;
  color: #fff;
  padding:6px 8px;
  border-radius:6px;
  cursor:pointer;
  font-size:14px;
}
.threadRateCount { font-weight: bold; margin-left:6px; color:#fff; font-size:14px; }

/* ç”»åƒãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
#imagePopup { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:3000; text-align:center; }
#popupImage { max-width:90%; max-height:90%; margin-top:5%; }
</style>
</head>

<body>
<h1>bord</h1>

<button id="adminBtn" class="redBtn" style="position: fixed; top:10px; left:10px;">ç®¡ç†è€…æ“ä½œ</button>

<!-- â–¼â–¼â–¼ ä¸¦ã³é †ã‚»ãƒ¬ã‚¯ãƒˆè¿½åŠ ï¼ˆä»Šå›è¿½åŠ ï¼‰ â–¼â–¼â–¼ -->
<select id="sortSelect">
  <option value="created_desc">ä½œæˆæ—¥ï¼ˆæ–°ã—ã„é †ï¼‰</option>
  <option value="created_asc">ä½œæˆæ—¥ï¼ˆå¤ã„é †ï¼‰</option>
  <option value="lastpost_desc">æœ€æ–°æŠ•ç¨¿é †</option>
  <option value="likes_desc">é«˜è©•ä¾¡é †</option>
  <option value="dislikes_desc">ä½è©•ä¾¡é †</option>
</select>
<!-- â–²â–²â–² è¿½åŠ ã“ã“ã¾ã§ â–²â–²â–² -->

<div id="threadListSection">
  <ul id="threadList"></ul>
  <div id="pagination"></div>
  <button id="createThreadBtn" class="greenBtn" style="position: fixed; bottom:70px; right:20px;">æ–°è¦ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ</button>
</div>

<div id="threadDetailSection">
  <div id="threadHeader">
    <h3 id="threadTitle"></h3>
    <small id="threadDetail"></small>
    <small id="threadCreator"></small>
  </div>
  <ol id="postList"></ol>
  <button id="createPostBtn" class="greenBtn" style="position: fixed; bottom:70px; right:20px;">æŠ•ç¨¿</button>
  <button id="closeThreadBtn" class="greenBtn" style="position: fixed; bottom:70px; left:20px;">æˆ»ã‚‹</button>
</div>

<div id="overlay"></div>

<!-- ãƒ•ã‚©ãƒ¼ãƒ ãªã©â€¦ï¼ˆã“ã“ã¯å…ƒã®HTMLã¨å®Œå…¨åŒã˜ãªã®ã§çœç•¥ã›ãšå…¥ã‚Œã¦ã„ã¾ã™ï¼‰ -->
  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { 
  getFirestore, collection, addDoc, query, orderBy, onSnapshot, Timestamp,
  getDocs, doc, deleteDoc, updateDoc
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC9ygh6HJX5mK1e5ZBnEWnLQCEjRMKIEWA",
  authDomain: "sinzo-3f972.firebaseapp.com",
  projectId: "sinzo-3f972",
  storageBucket: "sinzo-3f972.firebasestorage.app",
  messagingSenderId: "1058985227031",
  appId: "1:1058985227031:web:2e3a31346805442e10bd52"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ADMIN_PASSWORD = "2059";

/* NGãƒ¯ãƒ¼ãƒ‰ */
const NG_WORDS = [
  "æ­»ã­","æ®ºã™","ã¶ã£æ®ºã™","æ­»ã‚“ã§","åœ°ç„",
  "ã‚»ãƒƒã‚¯ã‚¹","ã‚¨ãƒ­","ã‚¢ãƒ€ãƒ«ãƒˆ","ã‚ã„ã›ã¤","è£¸","ä¸‹ç€","æ·«ã‚‰","å‘çŒ¥","ãƒŒãƒ¼ãƒ‰",
  "å¤‰æ…‹","æ€§äº¤","æ´åŠ©äº¤éš›","ä¸­å‡ºã—","ã‚ªãƒŠãƒ‹ãƒ¼","ãƒ‘ã‚¤ãƒ‘ãƒ³","ä¹±äº¤","ãƒ­ãƒª","ã‚·ãƒ§ã‚¿"
];
function containsNGWord(text){
  if(!text) return false;
  return NG_WORDS.some(w => text.includes(w));
}

/* Cookie */
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  return parts.length === 2 ? parts.pop().split(';')[0] : null;
}

/* ãƒ¬ãƒ¼ãƒˆã‚¯ãƒƒã‚­ãƒ¼ */
function setRateCookie(threadId, type) {
  const d = new Date();
  d.setTime(d.getTime() + (365*24*60*60*1000));
  document.cookie = `rate_${threadId}=${type}; expires=${d.toUTCString()}; path=/`;
}
function getRateCookie(threadId) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; rate_${threadId}=`);
  return parts.length === 2 ? parts.pop().split(";")[0] : null;
}

/* æ—¢å­˜ */
let nickName = getCookie("nickName") || "åç§°æœªè¨­å®š";
let iconBase64 = sessionStorage.getItem("icon") || null;
let currentThreadId = null;
let threadsData = [];
let currentPage = 1;
const pageSize = 10;
let postsUnsub = null;
let lockedThreads = new Set();

/* ä¸¦ã³é †ï¼ˆä»Šå›è¿½åŠ ï¼‰ */
let currentSort = "created_desc";

document.getElementById("sortSelect").addEventListener("change", (e)=>{
  currentSort = e.target.value;
  sortThreads();
  renderThreadsPage();
});

/* HTML è¦ç´  */
const threadListSection=document.getElementById('threadListSection');
const threadDetailSection=document.getElementById('threadDetailSection');
const threadTitleElem=document.getElementById('threadTitle');
const threadDetailElem=document.getElementById('threadDetail');
const threadCreatorElem=document.getElementById('threadCreator');

/* æ—¥ä»˜è¡¨ç¤º */
function formatDate(ts){ 
  const d = ts.toDate ? ts.toDate() : new Date(ts);
  return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
}
function formatRelativeTime(ts){
  const now=new Date();
  const d=ts.toDate?ts.toDate():new Date(ts);
  const diffMs=now-d;
  const sec=Math.floor(diffMs/1000);
  const min=Math.floor(sec/60);
  const hour=Math.floor(min/60);
  const day=Math.floor(hour/24);
  const base=formatDate(ts);
  if(day>0) return `${base} (${day}æ—¥å‰)`;
  if(hour>0) return `${base} (${hour}æ™‚é–“å‰)`;
  if(min>0) return `${base} (${min}åˆ†å‰)`;
  return `${base} (ãŸã£ãŸä»Š)`;
}

/* ä¸¦ã³æ›¿ãˆå‡¦ç†ï¼ˆä»Šå›è¿½åŠ ï¼‰ */
function sortThreads() {
  threadsData.sort((a,b)=>{
    const A=a.data();
    const B=b.data();

    if(currentSort==="created_desc")
      return B.created_at.seconds - A.created_at.seconds;

    if(currentSort==="created_asc")
      return A.created_at.seconds - B.created_at.seconds;

    if(currentSort==="lastpost_desc") {
      const la = A.lastPost_at ? A.lastPost_at.seconds : A.created_at.seconds;
      const lb = B.lastPost_at ? B.lastPost_at.seconds : B.created_at.seconds;
      return lb - la;
    }

    if(currentSort==="likes_desc")
      return (B.likes||0) - (A.likes||0);

    if(currentSort==="dislikes_desc")
      return (B.dislikes||0) - (A.dislikes||0);

    return 0;
  });
}

/* ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§æç”» */
function renderThreadsPage(){
  const threadList=document.getElementById('threadList');
  threadList.innerHTML="";
  const start=(currentPage-1)*pageSize;
  const pageThreads=threadsData.slice(start,start+pageSize);

  if(pageThreads.length===0){
    threadList.innerHTML="<li>ã¾ã ã‚ã‚Šã¾ã›ã‚“</li>";
    return;
  }

  pageThreads.forEach(docItem=>{
    const data = docItem.data();
    const li=document.createElement("li");
    li.style.backgroundColor = data.color;

    let titleText = data.locked ? `ğŸ”’${data.title}` : data.title;
    if(data.password) titleText += " ğŸ”‘";

    li.innerHTML = `
      <strong>${titleText}</strong><br>
      <small>æŠ•ç¨¿æ•°: ${data.postCount || 0}</small>
      <small>${data.detail || ""}</small>
    `;

    /* è©•ä¾¡ãƒœã‚¿ãƒ³ */
    const rateBox = document.createElement("div");
    rateBox.className = "threadRateBox";

    const likeBtn = document.createElement("button");
    likeBtn.className = "threadRateBtn";
    likeBtn.innerHTML = `ğŸ‘ <span class="threadRateCount">${data.likes || 0}</span>`;

    const dislikeBtn = document.createElement("button");
    dislikeBtn.className = "threadRateBtn";
    dislikeBtn.innerHTML = `ğŸ‘ <span class="threadRateCount">${data.dislikes || 0}</span>`;

    rateBox.appendChild(likeBtn);
    rateBox.appendChild(dislikeBtn);
    li.appendChild(rateBox);

    if(data.image){
      const btn=document.createElement("button");
      btn.textContent="ç”»åƒã‚’è¡¨ç¤º";
      btn.className="greenBtn";
      btn.style.display="block";
      btn.addEventListener("click",(e)=>{
        e.stopPropagation();
        showImagePopup(data.image);
      });
      li.appendChild(btn);
    }

    li.addEventListener("click",()=>{ tryOpenThread(docItem.id,data); });

    likeBtn.addEventListener("click", async (e)=>{
      e.stopPropagation();
      if(getRateCookie(docItem.id)){
        showAlert("1å›ã ã‘æŠ¼ã›ã¾ã™ï¼");
        return;
      }
      await updateDoc(doc(db,"threads",docItem.id),{ likes:(data.likes||0)+1 });
      setRateCookie(docItem.id,"like");
    });

    dislikeBtn.addEventListener("click", async (e)=>{
      e.stopPropagation();
      if(getRateCookie(docItem.id)){
        showAlert("1å›ã ã‘æŠ¼ã›ã¾ã™ï¼");
        return;
      }
      await updateDoc(doc(db,"threads",docItem.id),{ dislikes:(data.dislikes||0)+1 });
      setRateCookie(docItem.id,"dislike");
    });

    threadList.appendChild(li);
  });

  const totalPages=Math.max(1,Math.ceil(threadsData.length/pageSize));
  const pagination=document.getElementById('pagination');
  pagination.innerHTML="";
  for(let i=1;i<=totalPages;i++){
    const btn=document.createElement("button");
    btn.textContent=i;
    btn.className="pageBtn";
    if(i===currentPage) btn.disabled=true;
    btn.onclick=()=>{ currentPage=i; renderThreadsPage(); };
    pagination.appendChild(btn);
  }
}

/* Firestore ã‚¹ãƒ¬ãƒƒãƒ‰ç›£è¦– */
async function listenThreads(){
  const q=query(collection(db,"threads"));
  onSnapshot(q, async snapshot=>{
    const arr = await Promise.all(snapshot.docs.map(async d=>{
      const dat = d.data();
      const postsSnap = await getDocs(collection(db,"threads",d.id,"posts"));
      dat.postCount = postsSnap.size;
      if(dat.likes===undefined) dat.likes=0;
      if(dat.dislikes===undefined) dat.dislikes=0;
      return {id:d.id,data:()=>dat};
    }));
    threadsData=arr;
    sortThreads();
    renderThreadsPage();
  });
}

/* ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é–‹ã */
async function tryOpenThread(threadId, data){
  if(data.password){
    showForm("passwordFields");
    document.getElementById("popupTitle").textContent="ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰";

    document.getElementById("submitBtn").onclick=()=>{
      const val=document.getElementById("threadPasswordCheckInput").value.trim();
      if(val===data.password){
        closePopup();
        openThread(threadId,data);
      } else showAlert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
    };
  } else openThread(threadId,data);
}

function openThread(threadId,data){
  currentThreadId=threadId;
  threadTitleElem.textContent=data.title;
  threadDetailElem.textContent=data.detail||"";
  threadCreatorElem.textContent=`ä½œæˆè€…: ${data.memberId} ${formatDate(data.created_at)}`;

  threadListSection.style.display="none";
  threadDetailSection.style.display="block";

  loadPosts(threadId);
}

/* æŠ•ç¨¿èª­ã¿è¾¼ã¿ */
async function loadPosts(threadId){
  const postList=document.getElementById('postList');
  postList.innerHTML="";

  if(postsUnsub) postsUnsub();

  const q=query(collection(db,"threads",threadId,"posts"),orderBy("created_at","asc"));
  postsUnsub = onSnapshot(q,snapshot=>{
    postList.innerHTML="";
    let index=1;
    snapshot.forEach(p=>{
      const data=p.data();
      const li=document.createElement("li");
      li.style.backgroundColor=data.color;

      let body=(data.body||"").replace(/\n/g,"<br>");
      li.innerHTML = `#${index} <strong>${data.memberId}</strong>: ${body}`;

      const small=document.createElement("small");
      small.textContent=formatRelativeTime(data.created_at);
      li.appendChild(small);

      if(data.image){
        const btn=document.createElement("button");
        btn.className="greenBtn";
        btn.textContent="ç”»åƒã‚’è¡¨ç¤º";
        btn.onclick=()=>showImagePopup(data.image);
        li.appendChild(btn);
      }

      postList.appendChild(li);
      index++;
    });

    /* æœ€æ–°æŠ•ç¨¿æ—¥æ™‚ã‚’æ›´æ–°ï¼ˆä¸¦ã³æ›¿ãˆç”¨ï¼‰ */
    if(snapshot.size>0){
      const last = snapshot.docs[snapshot.docs.length-1].data();
      updateDoc(doc(db,"threads",threadId),{
        lastPost_at: last.created_at
      });
    }
  });
}

/* ç”»åƒãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
function showImagePopup(src){
  document.getElementById("popupImage").src=src;
  document.getElementById("imagePopup").style.display="block";
}
document.getElementById("closeImagePopup").onclick=()=>{
  document.getElementById("imagePopup").style.display="none";
};

/* è¿”å›ãƒœã‚¿ãƒ³ */
document.getElementById("closeThreadBtn").onclick=()=>{
  if(postsUnsub) postsUnsub();
  threadDetailSection.style.display="none";
  threadListSection.style.display="block";
};

/* æ–°è¦ã‚¹ãƒ¬ãƒƒãƒ‰ */
document.getElementById("createThreadBtn").onclick=()=>{
  showForm("threadFields");
  document.getElementById("popupTitle").textContent="æ–°è¦ã‚¹ãƒ¬ãƒƒãƒ‰";

  document.getElementById("submitBtn").onclick=async()=>{
    let name=document.getElementById("threadMemberId").value.trim();
    if(name) nickName=name;

    const iconF=document.getElementById("threadIconInput").files[0];
    if(iconF) iconBase64 = await fileToBase64(iconF);

    const title=document.getElementById("threadTitleInput").value.trim();
    const detail=document.getElementById("threadDetailInput").value.trim();
    if(containsNGWord(title)||containsNGWord(detail)){
      showAlert("ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™");
      return;
    }

    const imgF=document.getElementById("threadImageInput").files[0];
    const img=imgF?await fileToBase64(imgF):null;

    const password=document.getElementById("threadPasswordInput").value.trim();
    const color=document.getElementById("threadColorInput").value;

    if(!title){
      showAlert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    await addDoc(collection(db,"threads"),{
      memberId:nickName,
      icon:iconBase64,
      title, detail,
      image:img,
      password:password||null,
      color,
      created_at:Timestamp.now(),
      locked:false,
      likes:0,
      dislikes:0,
      lastPost_at:null
    });

    closePopup();
  };
};

/* æŠ•ç¨¿ä½œæˆ */
document.getElementById("createPostBtn").onclick=()=>{
  showForm("postFields");
  document.getElementById("popupTitle").textContent="æŠ•ç¨¿";

  document.getElementById("submitBtn").onclick=async()=>{
    let name=document.getElementById("postMemberId").value.trim();
    if(name) nickName=name;

    const iconF=document.getElementById("postIconInput").files[0];
    if(iconF) iconBase64=await fileToBase64(iconF);

    const body=document.getElementById("postBodyInput").value.trim();
    if(containsNGWord(body)){
      showAlert("ç¦æ­¢ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã™");
      return;
    }

    const imgF=document.getElementById("postImageInput").files[0];
    const img=imgF?await fileToBase64(imgF):null;

    const color=document.getElementById("postColorInput").value;

    if(!body && !img){
      showAlert("æœ¬æ–‡ã¾ãŸã¯ç”»åƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    await addDoc(collection(db,"threads",currentThreadId,"posts"),{
      memberId:nickName,
      icon:iconBase64,
      body,
      image:img,
      color,
      created_at:Timestamp.now()
    });

    /* æœ€æ–°æŠ•ç¨¿æ—¥æ™‚æ›´æ–°ï¼ˆä¸¦ã³æ›¿ãˆç”¨ï¼‰ */
    await updateDoc(doc(db,"threads",currentThreadId),{
      lastPost_at: Timestamp.now()
    });

    closePopup();
  };
};

/* ç®¡ç†è€…æ“ä½œï¼ˆå…ƒã®ã¾ã¾ï¼‰ */
document.getElementById("adminBtn").onclick=async()=>{
  showForm("adminFields");
  document.getElementById("popupTitle").textContent="ç®¡ç†è€…æ“ä½œ";

  const snap=await getDocs(collection(db,"threads"));
  const select=document.getElementById("adminThreadSelect");
  select.innerHTML="<option value=''>ã‚¹ãƒ¬ãƒƒãƒ‰é¸æŠ</option>";
  snap.forEach(d=>{
    const opt=document.createElement("option");
    opt.value=d.id;
    opt.textContent=d.data().title;
    select.appendChild(opt);
  });

  document.getElementById("submitBtn").onclick=async()=>{
    const pass=document.getElementById("adminPasswordInput").value;
    if(pass!==ADMIN_PASSWORD){ showAlert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•ã„"); return; }

    const action=document.querySelector("input[name='adminAction']:checked").value;
    const threadId=document.getElementById("adminThreadSelect").value;
    const postId=document.getElementById("adminPostSelect").value;

    if(action==="single" && threadId){
      await deleteDoc(doc(db,"threads",threadId));
    }
    if(action==="post" && threadId && postId){
      await deleteDoc(doc(db,"threads",threadId,"posts",postId));
    }
    if(action==="all"){
      const all=await getDocs(collection(db,"threads"));
      for(const d of all.docs){
        await deleteDoc(doc(db,"threads",d.id));
      }
    }
    if(action==="lock" && threadId){
      await updateDoc(doc(db,"threads",threadId),{ locked:true });
    }
    if(action==="unlock" && threadId){
      await updateDoc(doc(db,"threads",threadId),{ locked:false });
    }

    closePopup();
  };

  select.onchange=async()=>{
    const tid=select.value;
    const postSelect=document.getElementById("adminPostSelect");
    postSelect.innerHTML="<option value=''>æŠ•ç¨¿é¸æŠ</option>";
    if(tid){
      const ps=await getDocs(collection(db,"threads",tid,"posts"));
      ps.forEach(p=>{
        const opt=document.createElement("option");
        opt.value=p.id;
        opt.textContent=(p.data().body||"[ç”»åƒ]")?.slice(0,10);
        postSelect.appendChild(opt);
      });
    }
  };
};

/* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
function showForm(id){
  ["threadFields","postFields","adminFields","passwordFields"].forEach(
    e=>document.getElementById(e).style.display="none"
  );
  document.getElementById(id).style.display="block";
  document.getElementById("popupForm").style.display="block";
  document.getElementById("overlay").style.display="block";
}
function closePopup(){
  document.getElementById("popupForm").style.display="none";
  document.getElementById("overlay").style.display="none";
}
document.getElementById("closePopupBtn").onclick=closePopup;

/* ç”»åƒå¤‰æ› */
function fileToBase64(file){
  return new Promise(resolve=>{
    const r=new FileReader();
    r.onload=()=>resolve(r.result);
    r.readAsDataURL(file);
  });
}

/* åˆæœŸ */
listenThreads();
</script>

